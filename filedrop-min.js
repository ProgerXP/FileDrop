/*!
  FileDrop JavaScript classes | by Proger_XP | In public domain
  http://proger.i-forge.net/FileDrop/7CC
*/
;window.fd=window.fd||{logging:!0,onObjCall:null,all:[],isIE6:!1,isChrome:(navigator.vendor||"").indexOf("Google")!=-1,isFirebug:!!window.console&&!!window.console.dir},fd.RandomID=function(){return"fd_"+(Math.random()*1e4).toFixed()},fd.ByID=function(e){return fd.IsTag(e)?e:document.getElementById(e)},fd.IsTag=function(e,t){return typeof e=="object"&&e&&e.nodeType==1&&(!t||e.tagName.toUpperCase()==t.toUpperCase())},fd.NewXHR=function(){try{return new XMLHttpRequest}catch(e){var t=new Array("MSXML2.XMLHTTP.6.0","MSXML2.XMLHTTP.5.0","MSXML2.XMLHTTP.4.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP");for(var n=0;n<t.length&&!request;n++)try{return new ActiveXObject(t[n])}catch(e){}}},fd.IsArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"},fd.ToArray=function(e,t){return Array.prototype.slice.call(e,t||0)},fd.AddEvent=function(e,t,n){e.attachEvent?(e["e"+t+n]=n,e[t+n]=function(){e["e"+t+n](window.event)},e.attachEvent("on"+t,e[t+n])):e.addEventListener(t,n,!1)},fd.StopEvent=function(e){e.cancelBubble=!0,e.returnValue=!1,e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()},fd.SetClass=function(e,t,n){e=fd.ByID(e),fd.IsTag(e)&&(typeof n=="undefined"||n?fd.HasClass(e,t)||(e.className+=" "+t):e.className=e.className.replace(fd.ClassRegExp(t)," "))},fd.HasClass=function(e,t){return fd.ClassRegExp(t).test((fd.ByID(e)||{}).className)},fd.ClassRegExp=function(e){return e==null||e==""?/$o_O/:new RegExp("(^|\\s+)"+e+"(\\s+|$)","gi")},fd.Extend=function(e,t,n){for(var r in t)if(n||typeof e[r]=="undefined")e[r]=t[r]},fd.CallAll=function(e,t,n){t=[].concat(t);var r;if(fd.IsArray(e)){for(var i=0;i<e.length;i++)if(typeof e[i]=="function"){r=e[i].apply(n||this,t);if(r!=null)break}}else typeof e!="undefined"&&e!=null&&fd.isFirebug&&console.error("FileDrop event list must be either an Array or undefined/null, "+typeof e+" was given.");return r},fd.CallOf=function(e,t,n){if(fd.logging&&fd.isFirebug){var r=e.on[t]?e.on[t].length:0;console.info("FileDrop "+t+" event ("+r+"); args:"),console.dir([n])}var i=[fd.onObjCall].concat(e.on.event),s=fd.CallAll(i,[t].concat(n),e);return s!=null?s:fd.CallAll(e.on[t],n,e)},fd.DropHandle=function(e,t){var n=this;n.zone=e=fd.ByID(e);if(!e)throw"Cannot locate DOM node given to new FileDrop().";n.opt={zoneClass:"fd-zone",inputClass:"fd-file",iframe:{url:""},input:null,fullDocDragDetect:!1},fd.all.push(this),fd.Extend(n.opt,t,!0),fd.isChrome&&(n.opt.fullDocDragDetect=!0),n.on={event:[],dragEnter:[],dragLeave:[],dragOver:[],dragEnd:[],dragExit:[],upload:[],uploadElsewhere:[],inputSetup:[],iframeSetup:[],iframeDone:[]},n.Hook=function(e){n.opt.input!=0&&(n.opt.input=n.opt.input||n.PrepareInput(e),n.opt.input&&fd.CallOf(n,"inputSetup",n.opt.input)),n.HookDragOn(e),n.HookDropOn(e)},n.HookDragOn=function(e){function t(t,r){fd.AddEvent(r?document.body:e,t.toLowerCase(),function(e){fd.StopEvent(e),fd.CallOf(n,t,e)})}n.opt.fullDocDragDetect?(t("dragEnter",!0),fd.AddEvent(document,"dragleave",function(e){if(e.clientX==0&&e.clientY==0||fd.IsTag(e.relatedTarget,"html"))fd.StopEvent(e),fd.CallOf(n,"dragLeave",e)})):(t("dragEnter"),t("dragLeave")),fd.isChrome||t("dragOver"),t("dragEnd"),t("dragExit")},n.HookDropOn=function(e){function t(e){fd.StopEvent(e),fd.CallOf(n,"upload",e)}fd.isIE6||fd.AddEvent(e,"drop",t),n.opt.input&&fd.AddEvent(n.opt.input.file,"change",t)},n.PrepareInput=function(e){var t={file:n.FindInputRec(e)||n.CreateInputAt(e)};if(t.file){var r=t.file.parentNode;while(r&&!fd.IsTag(r,"form"))r=t.form.parentNode;var i=r?r.getAttribute("target"):"";i&&fd.IsTag(fd.ByID(i),"iframe")&&(t.form=r)}return t},n.FindInputRec=function(e){var t;for(var r=0;!t&&r<e.childNodes.length;r++){var i=e.childNodes[r];fd.IsTag(i,"input")&&i.getAttribute("type")=="file"&&fd.HasClass(i,n.opt.inputClass)?t=i:i.childNodes.length>0&&(t=n.FindInputRec(i))}return t},n.CreateInputAt=function(e){do var t=fd.RandomID();while(fd.ByID(t));var n=document.createElement("div");n.innerHTML='<iframe src="javascript:false;" name="'+t+'"></iframe>'+'<form method="post" enctype="multipart/form-data">'+'<input type="hidden" name="fd-callback" />'+'<input type="file" name="fd-file" />'+"</form>",n.firstChild.setAttribute("id",t),n.firstChild.style.display="none",n.lastChild.setAttribute("target",t);var r=e.firstChild;while(r&&(!fd.IsTag(r)||fd.IsTag(r,"legend")))r=r.nextSibling;return r?e.insertBefore(n,r):e.appendChild(n),n.lastChild.lastChild},n.AbortIFrame=function(){if(n.opt.input.form){var e=fd.ByID(n.opt.input.form.getAttribute("target"));e&&e.setAttribute("src","javascript:false;")}},n.SendViaIFrame=function(e){e=e||n.opt.iframe.url;var t=(n.opt.input||{}).form;if(e&&t){if(!("__proto__"in{})&&(!n.opt.input.file.value||n.opt.input.file.value.length<3))return;do var r=fd.RandomID();while(window[r]);window[r]=function(t){var r=typeof t=="object"?t:{response:t,responseText:t,readyState:4,status:200};fd.Extend(r,{iframe:!0,url:e}),fd.CallOf(n,"iframeDone",r)};var i=t.firstChild;while(i&&(!fd.IsTag(i,"input")||i.name!="fd-callback"))i=i.nextSibling;i?i.value=r:e=e.replace(/[?&]$/,"")+(e.indexOf("?")==-1?"?":"&")+"fd-callback="+r,t.setAttribute("action",e),fd.CallOf(n,"iframeSetup",t),t.submit()}},n.Multiple=function(e){if(!n.opt.input)throw"FileDrop.Multiple(): no self.opt.input assigned.";return typeof e!="undefined"&&(e?n.opt.input.file.setAttribute("multiple","multiple"):n.opt.input.file.removeAttribute("multiple")),!!n.opt.input.file.getAttribute("multiple")},n.SetupInput=function(t){t.file.className=n.opt.inputClass;var r=t.file.parentNode;r&&r.style.display.match(/^(static)?$/)&&(r.style.position="relative");if(fd.IsTag(e,"fieldset")){var i=document.createElement("div");i.style.position="relative",i.style.overflow="hidden",e.parentNode.insertBefore(i,e),i.appendChild(e)}},n.on.inputSetup.push(n.SetupInput),n.on.upload.push(function(){for(var e=0;e<fd.all.length;e++)fd.all[e]!==n&&fd.all[e].on&&fd.CallOf(fd.all[e],"uploadElsewhere"
,n)}),fd.SetClass(e,n.opt.zoneClass),n.Hook(e)},fd.FileDrop=function(e,t){var n=this;e=fd.ByID(e),n.handle=new fd.DropHandle(e,t),n.opt=n.handle.opt,fd.Extend(n.opt,{dragOverClass:"over"}),fd.Extend(n.opt.iframe,{force:!1}),fd.Extend(n.opt,t,!0),n.on=n.handle.on,fd.Extend(n.on,{send:[],fileSetup:[]}),n.SetClassesTo=function(e,t){fd.SetClass(e,n.opt.dragOverClass,t)},n.OnUpload=function(e){var t=!n.opt.iframe.force&&n.GetFilesFrom(e);t==0?n.handle.SendViaIFrame():t.length>0&&fd.CallOf(n,"send",[t])},n.GetFilesFrom=function(e){var t=e.dataTransfer?e.dataTransfer:e.target?e.target.files:!1;if(t==0)return!1;t.files&&(t=t.files);var r=[],i={};for(var s=0;s<t.length;s++){var o=new fd.File(t[s]);if(i[o.name])continue;i[o.name]=!0,fd.CallOf(n,"fileSetup",o),o.size>0&&r.push(o)}return r},n.on.upload.push(n.OnUpload),n.on.dragEnter.push(function(){n.SetClassesTo(e,!0)}),n.on.dragLeave.push(function(){n.SetClassesTo(e,!1)}),n.on.upload.unshift(function(){n.SetClassesTo(e,!1)}),n.on.uploadElsewhere.push(function(){n.SetClassesTo(e,!1)}),fd.Extend(n,n.handle)},window.FileDrop=fd.FileDrop,fd.File=function(e){var t=this;t.nativeFile=e,t.name=e.fileName||e.name,t.size=e.fileSize||e.size,t.xhr=null,t.opt={extraHeaders:!0},t.on={event:[],sendXHR:[],progress:[],done:[],error:[]},t.SendTo=function(e){if(window.FileReader){var n=new FileReader;n.onload=function(n){t.DoSendTo(e,n)},n.onerror=function(e){fd.CallOf(t,"error",[e])},n.readAsBinaryString(t.nativeFile)}else t.DoSendTo(e)},t.DoSendTo=function(e,n){t.Abort(),t.xhr=fd.NewXHR(),t.HookXHR(t.xhr),t.xhr.open("POST",e,!0),t.xhr.overrideMimeType("application/octet-stream"),t.xhr.setRequestHeader("Content-Type","application/octet-stream");if(t.opt.extraHeaders){t.xhr.setRequestHeader("X-File-Name",encodeURIComponent(t.name)),t.xhr.setRequestHeader("X-File-Size",t.size);var r=window.FileReader?"FileAPI":"Webkit";t.xhr.setRequestHeader("X-Requested-With","FileDrop-XHR-"+r)}var i=n&&n.target&&n.target.result?n.target.result:t.nativeFile;fd.CallOf(t,"sendXHR",[t.xhr,i])},t.HookXHR=function(e){var n=e.upload||e;e.onreadystatechange=function(n){if(e.readyState==4){try{var r=e.status==200?"done":"error"}catch(n){var r="error"}var i=r=="error"?[n,e]:[e,n];fd.CallOf(t,r,i)}},n.onprogress=function(n){var r=n.lengthComputable?n.loaded:null;fd.CallOf(t,"progress",[r,n.total,e,n])}},t.Abort=function(){t.xhr&&t.xhr.abort&&t.xhr.abort()},t.SendXHR=function(e,t){if(e.sendAsBinary)e.sendAsBinary(t);else if(typeof t=="string")try{var n=Array.prototype.map.call(t,function(e){return e.charCodeAt(0)&255}),r=new Uint8Array(n);e.send(r.buffer)}catch(i){e.send(t)}else e.send(t)},t.on.sendXHR.push(t.SendXHR)},fd.jQuery=function(e){e=e||jQuery||window.$;if(!e)throw"No jQuery/$ object to integrate FileDrop into.";e.fn.filedrop=function(t){function n(e,t){return function(n){var i=(t||[]).concat(fd.ToArray(arguments,1));return r.triggerHandler(e+n,i)}}var r=this,i=this.data("filedrop");if(typeof t=="string")if(!i)e.error("$.filedrop('comment') needs an initialized FilrDrop on this element.");else{if(typeof i[t]!="undefined"){var s=i[t];return typeof s=="function"?s.apply(i,fd.ToArray(arguments,1)):s}e.error("There's no method or property FileDrop."+t+".")}else if(!t||typeof t=="object")if(!i){var o=new FileDrop(this[0],t);this.data("filedrop",o),o.on.event.push(n("fd")),o.on.fileSetup.push(function(e){e.on.event.push(n("file",[e]))})}else{if(!t)return i;fd.Extend(i.opt,t,!0)}else e.error("Invalid $.filedrop() parameter - expected nothing (creates new zone), a string (property to access) or an object (custom zone options).");return r}};
